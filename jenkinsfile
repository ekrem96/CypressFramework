pipeline {
	agent any

	options {
        // This is required if you want to clean before build
        skipDefaultCheckout(true)
    }

	stages{
		stage('Cleanup'){
			steps{
				cleanWs()
				checkout scm
				echo 'remove docker images'
				script{
					try{
						sh 'docker image rm cypress-runner-image'
					}
					catch(err){
						echo err
					}
				}
			}
		}
		stage('Setup'){
			steps{
				sh 'git clone https://github.com/ekrem96/CypressFramework.git'
				sh 'docker build -t cypress-runner-image .'
			}
		}
		stage('Testing'){
			steps{
				sh 'docker run --rm -v "${WORKSPACE}/cypress/reports:/tests/cypress/reports" cypress-runner-image -b chrome' 
			}
		}
	}
	 post {
        // Clean after build
        always {
            cleanWs(cleanWhenNotBuilt: false,
                    deleteDirs: true,
                    disableDeferredWipeout: true,
                    notFailBuild: true,
                    patterns: [[pattern: '.gitignore', type: 'INCLUDE'],
                               [pattern: '.propsfile', type: 'EXCLUDE']])
        }
    }
}